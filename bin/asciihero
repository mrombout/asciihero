#!/usr/bin/env node
'use strict'

const { Options, Invoker, processor } = require('@asciidoctor/cli')
const pkg = require('../package.json')
const converter = require('asciidoctor-pdf/lib/converter.js')
const extensions = require('../packages/asciihero/extensions.js')
const path = require('node:path')
const GamebookConverter = require('../packages/gamebookml/converter.js')

process.title = 'asciihero'

async function convertFiles (files, verbose, convertFn) {
  for (const file of files) {
    if (verbose) {
      console.log(`converting file ${file.contents ? '-' : file.path}`)
    }
    await convertFn(file)
  }
}

function convertPdf (argv, options, preview) {
  return function (file) {
    return converter.convert(processor, file, options, argv.timings, argv.watch, preview)
  }
}

function convertGamebookML (options) {
  return function (file) {
    processor.convertFile(file.path, options)
  }
}

class AsciiHeroOptions {
  constructor () {
    this.options = new Options({})
      .addOption('preview', {
        default: false,
        describe: 'open the otherwise headless browser for inspecting the generated HTML document (before it gets converted to PDF)',
        type: 'boolean'
      })
  }

  parse (argv) {
    return this.options.parse(argv)
  }
}

class AsciiHeroInvoker extends Invoker {
  async invoke () {
    const cliOptions = this.options
    const processArgs = cliOptions.argv.slice(2)
    const { args } = cliOptions
    const { verbose, version, files, preview, backend } = args
    if (version || (verbose && processArgs.length === 1)) {
      this.showVersion()
      return { exit: true }
    }

    const asciidoctorOptions = cliOptions.options
    const stylesheetBase = path.resolve(__dirname, '../base.css')
    const stylesheetFightingFantasy = path.resolve(__dirname, '../ff.css')
    cliOptions.attributes.push(`stylesheet=${stylesheetBase},${stylesheetFightingFantasy}`)

    const templates = require('asciidoctor-pdf/lib/document/document-converter.js').templates
    converter.registerTemplateConverter(processor, templates)

    extensions.register(processor.Extensions)

    processor.ConverterFactory.register(new GamebookConverter(), ['gamebookml'])

    Invoker.prepareProcessor(args, processor)
    if (files && files.length > 0) {
      const fileObjects = files.map(file => ({ path: file }))

      if (backend === 'gamebookml') {
        await convertFiles(fileObjects, verbose, convertGamebookML(asciidoctorOptions))
      } else {
        await convertFiles(fileObjects, verbose, convertPdf(args, asciidoctorOptions, preview))
      }
      return { exit: true }
    }

    this.showHelp()
    return { exit: true }
  }

  version () {
    return `AsciiHero ${pkg.version} using ${super.version()}`
  }
}

;(async () => {
  const options = new AsciiHeroOptions().parse(process.argv)
  return new AsciiHeroInvoker(options).invoke()
})()
  .then((result) => {
    if (result.exit) {
      process.exit(0)
    }
  })
  .catch((error) => {
    console.error('ERROR: ', error)
    process.exit(1)
  })
